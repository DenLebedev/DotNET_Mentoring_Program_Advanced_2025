ú)
QD:\EBSCO\GitHub\DotNET_Mentoring_Program_Advanced_2025\IdentityService\Program.cs
var		 
builder		 
=		 
WebApplication		 
.		 
CreateBuilder		 *
(		* +
args		+ /
)		/ 0
;		0 1
builder 
. 
Services 
. 
AddDbContext 
<  
ApplicationDbContext 2
>2 3
(3 4
options4 ;
=>< >
options 
. 
UseInMemoryDatabase 
(  
$str  ,
), -
)- .
;. /
builder 
. 
Services 
. 
AddIdentity 
< 
IdentityUser )
,) *
IdentityRole+ 7
>7 8
(8 9
options9 @
=>A C
{ 
options 
. 
Password 
. "
RequireNonAlphanumeric +
=, -
false. 3
;3 4
options 
. 
Password 
. 
RequireUppercase %
=& '
false( -
;- .
options 
. 
Password 
. 
RequiredLength #
=$ %
$num& '
;' (
} 
) 
. $
AddEntityFrameworkStores 
<  
ApplicationDbContext 2
>2 3
(3 4
)4 5
. $
AddDefaultTokenProviders 
( 
) 
;  
builder 
. 
Services 
. 
AddIdentityServer "
(" #
options# *
=>+ -
{ 
options 
. #
EmitStaticAudienceClaim #
=$ %
true& *
;* +
} 
) 
. 
AddAspNetIdentity 
< 
IdentityUser 
>  
(  !
)! "
. (
AddInMemoryIdentityResources 
( 
Config $
.$ %
IdentityResources% 6
)6 7
.  
AddInMemoryApiScopes 
( 
Config 
. 
	ApiScopes &
)& '
. #
AddInMemoryApiResources 
( 
Config 
.  
ApiResources  ,
), -
. 
AddInMemoryClients 
( 
Config 
. 
Clients "
)" #
.   )
AddDeveloperSigningCredential   
(   
)    
;    !
builder## 
.## 
Services## 
.## 
AddCors## 
(## 
options##  
=>##! #
{$$ 
options%% 
.%% 
AddDefaultPolicy%% 
(%% 
policy%% #
=>%%$ &
{&& 
policy'' 
.'' 
WithOrigins'' 
('' 
$str'' 3
,''3 4
$str''5 M
)''M N
.(( 
AllowAnyHeader(( 
((( 
)(( 
.)) 
AllowAnyMethod)) 
()) 
))) 
;))  
}** 
)** 
;** 
}++ 
)++ 
;++ 
builder-- 
.-- 
Services-- 
.-- 
AddControllers-- 
(--  
)--  !
;--! "
var// 
app// 
=// 	
builder//
 
.// 
Build// 
(// 
)// 
;// 
using11 
(11 
var11 

scope11 
=11 
app11 
.11 
Services11 
.11  
CreateScope11  +
(11+ ,
)11, -
)11- .
{22 
var33 
userManager33 
=33 
scope33 
.33 
ServiceProvider33 +
.33+ ,
GetRequiredService33, >
<33> ?
UserManager33? J
<33J K
IdentityUser33K W
>33W X
>33X Y
(33Y Z
)33Z [
;33[ \
var44 
roleManager44 
=44 
scope44 
.44 
ServiceProvider44 +
.44+ ,
GetRequiredService44, >
<44> ?
RoleManager44? J
<44J K
IdentityRole44K W
>44W X
>44X Y
(44Y Z
)44Z [
;44[ \
await55 	
DbInitializer55
 
.55 
	SeedAsync55 !
(55! "
userManager55" -
,55- .
roleManager55/ :
)55: ;
;55; <
}66 
app88 
.88 

UseRouting88 
(88 
)88 
;88 
app99 
.99 
UseCors99 
(99 
)99 
;99 
app:: 
.:: 
UseIdentityServer:: 
(:: 
):: 
;:: 
app;; 
.;; 
MapControllers;; 
(;; 
);; 
;;; 
app== 
.== 
Run== 
(== 
)== 	
;==	 
ƒ,
\D:\EBSCO\GitHub\DotNET_Mentoring_Program_Advanced_2025\IdentityService\Data\DbInitializer.cs
	namespace 	
IdentityService
 
. 
Data 
{ 
public 

static 
class 
DbInitializer %
{ 
public 
static 
async 
Task  
	SeedAsync! *
(* +
UserManager+ 6
<6 7
IdentityUser7 C
>C D
userManagerE P
,P Q
RoleManagerR ]
<] ^
IdentityRole^ j
>j k
roleManagerl w
)w x
{		 	
string 
[ 
] 
roles 
= 
{ 
$str (
,( )
$str* 9
}: ;
;; <
foreach 
( 
var 
role 
in  
roles! &
)& '
{ 
if 
( 
! 
await 
roleManager &
.& '
RoleExistsAsync' 6
(6 7
role7 ;
); <
)< =
{ 
await 
roleManager %
.% &
CreateAsync& 1
(1 2
new2 5
IdentityRole6 B
(B C
roleC G
)G H
)H I
;I J
} 
} 
var 
managerUser 
= 
new !
IdentityUser" .
{/ 0
UserName1 9
=: ;
$str< N
,N O
EmailP U
=V W
$strX j
,j k
EmailConfirmedl z
={ |
true	} Å
}
Ç É
;
É Ñ
var 
customerUser 
= 
new "
IdentityUser# /
{0 1
UserName2 :
=; <
$str= P
,P Q
EmailR W
=X Y
$strZ m
,m n
EmailConfirmedo }
=~ 
true
Ä Ñ
}
Ö Ü
;
Ü á
await !
CreateUserIfNotExists '
(' (
userManager( 3
,3 4
managerUser5 @
,@ A
$strB K
,K L
$strM Z
,Z [
new\ _
[_ `
]` a
{b c
$strd j
,j k
$strl t
,t u
$strv ~
,~ 
$str
Ä à
}
â ä
)
ä ã
;
ã å
await !
CreateUserIfNotExists '
(' (
userManager( 3
,3 4
customerUser5 A
,A B
$strC R
,R S
$strT b
,b c
newd g
[g h
]h i
{j k
$strl r
}s t
)t u
;u v
} 	
private 
static 
async 
Task !!
CreateUserIfNotExists" 7
(7 8
UserManager8 C
<C D
IdentityUserD P
>P Q
userManagerR ]
,] ^
IdentityUser_ k
userl p
,p q
stringr x
roley }
,} ~
string	 Ö
password
Ü é
,
é è
string
ê ñ
[
ñ ó
]
ó ò
permissions
ô §
)
§ •
{ 	
if 
( 
string 
. 
IsNullOrEmpty $
($ %
user% )
.) *
Email* /
)/ 0
)0 1
throw 
new 
ArgumentException +
(+ ,
$str, Q
,Q R
nameofS Y
(Y Z
userZ ^
.^ _
Email_ d
)d e
)e f
;f g
var!! 
existingUser!! 
=!! 
await!! $
userManager!!% 0
.!!0 1
FindByEmailAsync!!1 A
(!!A B
user!!B F
.!!F G
Email!!G L
)!!L M
;!!M N
if"" 
("" 
existingUser"" 
!="" 
null""  $
)""$ %
return## 
;## 
var%% 
createResult%% 
=%% 
await%% $
userManager%%% 0
.%%0 1
CreateAsync%%1 <
(%%< =
user%%= A
,%%A B
password%%C K
)%%K L
;%%L M
if&& 
(&& 
!&& 
createResult&& 
.&& 
	Succeeded&& '
)&&' (
return'' 
;'' 
await)) 
userManager)) 
.)) 
AddToRoleAsync)) ,
()), -
user))- 1
,))1 2
role))3 7
)))7 8
;))8 9
await++ 
userManager++ 
.++ 
AddClaimAsync++ +
(+++ ,
user++, 0
,++0 1
new++2 5
Claim++6 ;
(++; <

ClaimTypes++< F
.++F G
Role++G K
,++K L
role++M Q
)++Q R
)++R S
;++S T
foreach-- 
(-- 
var-- 

permission-- #
in--$ &
permissions--' 2
)--2 3
{.. 
await// 
userManager// !
.//! "
AddClaimAsync//" /
(/// 0
user//0 4
,//4 5
new//6 9
Claim//: ?
(//? @
$str//@ L
,//L M

permission//N X
)//X Y
)//Y Z
;//Z [
}00 
}11 	
}22 
}33 ÿ
cD:\EBSCO\GitHub\DotNET_Mentoring_Program_Advanced_2025\IdentityService\Data\ApplicationDbContext.cs
	namespace 	
IdentityService
 
. 
Data 
{ 
public 

class  
ApplicationDbContext %
:& '
IdentityDbContext( 9
<9 :
IdentityUser: F
>F G
{ 
public		  
ApplicationDbContext		 #
(		# $
DbContextOptions		$ 4
<		4 5 
ApplicationDbContext		5 I
>		I J
options		K R
)		R S
:

 
base

 
(

 
options

 
)

 
{ 	
} 	
} 
} ‡ 
WD:\EBSCO\GitHub\DotNET_Mentoring_Program_Advanced_2025\IdentityService\Config\Config.cs
	namespace 	
IdentityService
 
. 
Config  
{ 
public 

static 
class 
Config 
{ 
public 
static 
IEnumerable !
<! "
IdentityResource" 2
>2 3
IdentityResources4 E
=>F H
new 
IdentityResource  
[  !
]! "
{		 
new

 
IdentityResources

 %
.

% &
OpenId

& ,
(

, -
)

- .
,

. /
new 
IdentityResources %
.% &
Profile& -
(- .
). /
,/ 0
new 
IdentityResource $
($ %
$str% ,
,, -
$str. <
,< =
new> A
[A B
]B C
{D E
$strF L
}M N
)N O
} 
; 
public 
static 
IEnumerable !
<! "
ApiScope" *
>* +
	ApiScopes, 5
=>6 8
new 
ApiScope 
[ 
] 
{ 
new 
ApiScope 
( 
$str *
,* +
$str, C
)C D
,D E
new 
ApiScope 
( 
$str *
,* +
$str, C
)C D
,D E
new 
ApiScope 
( 
$str -
,- .
$str/ H
)H I
} 
; 
public 
static 
IEnumerable !
<! "
ApiResource" -
>- .
ApiResources/ ;
=>< >
new 
ApiResource 
[ 
] 
{ 
new 
ApiResource 
(  
$str  6
,6 7
$str8 E
)E F
{ 
Scopes 
= 
{ 
$str ,
}- .
,. /

UserClaims 
=  
{! "
$str# )
,) *
$str+ 7
}8 9
} 
, 
new 
ApiResource 
(  
$str  6
,6 7
$str8 E
)E F
{   
Scopes!! 
=!! 
{!! 
$str!! ,
}!!- .
,!!. /

UserClaims"" 
=""  
{""! "
$str""# )
,"") *
$str""+ 7
}""8 9
}## 
}$$ 
;$$ 
public&& 
static&& 
IEnumerable&& !
<&&! "
Client&&" (
>&&( )
Clients&&* 1
=>&&2 4
new'' 
Client'' 
['' 
]'' 
{(( 
new)) 
Client)) 
{** 
ClientId++ 
=++ 
$str++ +
,+++ ,
AllowedGrantTypes,, %
=,,& '

GrantTypes,,( 2
.,,2 3!
ResourceOwnerPassword,,3 H
,,,H I
ClientSecrets-- !
=--" #
{--$ %
new--& )
Secret--* 0
(--0 1
$str--1 A
.--A B
Sha256--B H
(--H I
)--I J
)--J K
}--L M
,--M N
AllowedScopes.. !
=.." #
{..$ %
$str//  
,//  !
$str//" +
,//+ ,
$str//- 4
,//4 5
$str//6 C
,//C D
$str//E R
,//R S
$str//T d
}00 
,00 
AllowOfflineAccess11 &
=11' (
true11) -
,11- .
AccessTokenLifetime22 '
=22( )
$num22* -
,22- .
RefreshTokenUsage33 %
=33& '

TokenUsage33( 2
.332 3
ReUse333 8
,338 9(
AbsoluteRefreshTokenLifetime44 0
=441 2
$num443 :
}55 
}66 
;66 
}77 
}88 